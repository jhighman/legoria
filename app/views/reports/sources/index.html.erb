<% content_for :title, "Source Effectiveness Report" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">Source Effectiveness Report</h1>
    <p class="text-muted mb-0">Analyze application sources and their conversion rates</p>
  </div>
  <%= render "reports/shared/export_buttons", csv_path: export_reports_sources_path(request.query_parameters) %>
</div>

<%= render "reports/shared/date_range_filter", jobs: @jobs, departments: @departments, show_filters: true %>

<!-- Summary Cards -->
<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <div class="display-4 fw-bold text-primary"><%= @data[:summary][:total_applications] %></div>
        <div class="text-muted">Total Applications</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <div class="display-4 fw-bold text-info"><%= @data[:summary][:unique_sources] %></div>
        <div class="text-muted">Active Sources</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <div class="display-4 fw-bold text-success"><%= @data[:summary][:total_hires] %></div>
        <div class="text-muted">Total Hires</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <div class="display-4 fw-bold text-warning"><%= @data[:summary][:overall_conversion] %>%</div>
        <div class="text-muted">Overall Conversion</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Source Chart -->
  <div class="col-md-8">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="card-title mb-0">Applications by Source</h5>
      </div>
      <div class="card-body">
        <% if @data[:by_source].any? %>
          <div data-controller="chart"
               data-chart-type-value="bar"
               data-chart-data-value="<%= {
                 labels: @data[:by_source].first(8).map { |s| s[:source_label] },
                 datasets: [{
                   label: 'Applications',
                   data: @data[:by_source].first(8).map { |s| s[:applications] },
                   backgroundColor: '#3B82F6'
                 }, {
                   label: 'Hires',
                   data: @data[:by_source].first(8).map { |s| s[:hired] },
                   backgroundColor: '#10B981'
                 }]
               }.to_json %>">
            <canvas data-chart-target="canvas" height="150"></canvas>
          </div>
        <% else %>
          <div class="text-center text-muted py-5">
            <i class="bi bi-bar-chart fs-1 d-block mb-3"></i>
            <p>No data available for the selected date range</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Conversion Funnel -->
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="card-title mb-0">Top Converting Sources</h5>
      </div>
      <div class="card-body p-0">
        <% top_sources = @data[:by_source].select { |s| s[:applications] >= 5 }.sort_by { |s| -s[:conversion_rate] } %>
        <% if top_sources.any? %>
          <ul class="list-group list-group-flush">
            <% top_sources.first(5).each do |source| %>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong><%= source[:source_label] %></strong>
                  <br>
                  <small class="text-muted"><%= source[:applications] %> applications</small>
                </div>
                <span class="badge bg-<%= source[:conversion_rate] >= 20 ? 'success' : source[:conversion_rate] >= 10 ? 'warning' : 'secondary' %> fs-6">
                  <%= source[:conversion_rate] %>%
                </span>
              </li>
            <% end %>
          </ul>
        <% else %>
          <div class="text-center text-muted py-4">
            <small>Need at least 5 applications per source</small>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Detailed Source Table -->
<div class="card mt-4">
  <div class="card-header">
    <h5 class="card-title mb-0">Source Breakdown</h5>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Source</th>
            <th class="text-end">Applications</th>
            <th class="text-end">In Progress</th>
            <th class="text-end">Hired</th>
            <th class="text-end">Rejected</th>
            <th class="text-end">Conversion Rate</th>
            <th class="text-end">Quality Score</th>
          </tr>
        </thead>
        <tbody>
          <% @data[:by_source].each do |source| %>
            <tr>
              <td><%= source[:source_label] %></td>
              <td class="text-end"><%= source[:applications] %></td>
              <td class="text-end"><%= source[:in_progress] %></td>
              <td class="text-end text-success"><%= source[:hired] %></td>
              <td class="text-end text-danger"><%= source[:rejected] %></td>
              <td class="text-end">
                <div class="progress" style="height: 20px; min-width: 100px;">
                  <div class="progress-bar bg-success" style="width: <%= source[:conversion_rate] %>%;">
                    <%= source[:conversion_rate] %>%
                  </div>
                </div>
              </td>
              <td class="text-end">
                <span class="badge bg-<%= source[:quality_score] >= 50 ? 'success' : source[:quality_score] >= 25 ? 'warning' : 'secondary' %>">
                  <%= source[:quality_score] %>
                </span>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Quality Metrics -->
<div class="card mt-4">
  <div class="card-header">
    <h5 class="card-title mb-0">Source Quality Metrics</h5>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Source</th>
            <th class="text-end">Avg Rating</th>
            <th class="text-end">Avg Time to Hire</th>
            <th class="text-end">Interview Rate</th>
          </tr>
        </thead>
        <tbody>
          <% @data[:quality_metrics].each do |source| %>
            <tr>
              <td><%= source[:source_label] %></td>
              <td class="text-end">
                <% if source[:average_rating] > 0 %>
                  <% source[:average_rating].floor.times do %>
                    <i class="bi bi-star-fill text-warning"></i>
                  <% end %>
                  <% if source[:average_rating] % 1 >= 0.5 %>
                    <i class="bi bi-star-half text-warning"></i>
                  <% end %>
                  <small class="text-muted ms-1">(<%= source[:average_rating] %>)</small>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td class="text-end">
                <% if source[:avg_time_to_hire] %>
                  <%= source[:avg_time_to_hire] %> days
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td class="text-end"><%= source[:interview_rate] %>%</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
