<% content_for :title, "Diversity Metrics" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">Diversity Metrics</h1>
    <p class="text-muted mb-0">Workforce diversity analysis and trends</p>
  </div>
  <div class="btn-group">
    <%= link_to adverse_impact_reports_diversity_index_path(request.query_parameters), class: "btn btn-outline-warning" do %>
      <i class="bi bi-exclamation-triangle me-1"></i> Adverse Impact Analysis
    <% end %>
    <%= link_to pdf_reports_diversity_index_path(request.query_parameters), class: "btn btn-outline-secondary" do %>
      <i class="bi bi-file-earmark-pdf me-1"></i> Export PDF
    <% end %>
  </div>
</div>

<div class="alert alert-info mb-4">
  <i class="bi bi-shield-lock me-2"></i>
  <strong>Privacy Protected:</strong> Groups with fewer than 5 members are anonymized to protect individual privacy.
</div>

<%= render "reports/shared/date_range_filter", jobs: @jobs, departments: @departments, show_filters: true %>

<!-- Diversity Summary -->
<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <div class="display-4 fw-bold text-primary"><%= @data[:summary][:total_respondents] %></div>
        <div class="text-muted">Respondents</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100 <%= @data[:summary][:diversity_index] >= 0.6 ? 'border-success' : @data[:summary][:diversity_index] >= 0.3 ? 'border-warning' : 'border-danger' %>">
      <div class="card-body text-center">
        <div class="display-4 fw-bold"><%= @data[:summary][:diversity_index] %></div>
        <div class="text-muted">Diversity Index</div>
        <span class="badge bg-<%= @data[:summary][:diversity_index] >= 0.6 ? 'success' : @data[:summary][:diversity_index] >= 0.3 ? 'warning' : 'danger' %>">
          <%= @data[:summary][:diversity_index_label] %>
        </span>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <div class="display-4 fw-bold text-info"><%= @data[:summary][:underrepresented_percentage] %>%</div>
        <div class="text-muted">Underrepresented Groups</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <% female_ratio = @data[:summary][:gender_ratio][:female] || 0 %>
        <div class="display-4 fw-bold text-purple"><%= female_ratio %>%</div>
        <div class="text-muted">Female</div>
        <div class="progress mt-2" style="height: 8px;">
          <div class="progress-bar bg-primary" style="width: <%= female_ratio %>%;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<% if @data[:summary][:note] %>
  <div class="alert alert-warning">
    <i class="bi bi-info-circle me-2"></i>
    <%= @data[:summary][:note] %>
  </div>
<% end %>

<div class="row g-4">
  <!-- Race/Ethnicity Representation -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="card-title mb-0">Race/Ethnicity Representation</h5>
      </div>
      <div class="card-body">
        <% visible_races = @data[:representation][:by_race].reject { |r| r[:anonymized] } %>
        <% if visible_races.any? %>
          <div data-controller="chart"
               data-chart-type-value="doughnut"
               data-chart-data-value="<%= {
                 labels: visible_races.map { |r| r[:label] },
                 datasets: [{
                   data: visible_races.map { |r| r[:count] },
                   backgroundColor: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#6B7280']
                 }]
               }.to_json %>">
            <canvas data-chart-target="canvas"></canvas>
          </div>
        <% else %>
          <div class="text-center text-muted py-4">Insufficient data for visualization</div>
        <% end %>
      </div>
      <div class="card-footer p-0">
        <table class="table table-sm mb-0">
          <tbody>
            <% @data[:representation][:by_race].each do |row| %>
              <tr class="<%= row[:anonymized] ? 'text-muted' : '' %>">
                <td><%= row[:label] %></td>
                <td class="text-end">
                  <%= row[:anonymized] ? row[:count] : row[:count] %>
                </td>
                <td class="text-end">
                  <%= row[:percentage] ? "#{row[:percentage]}%" : "-" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Gender Representation -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="card-title mb-0">Gender Representation</h5>
      </div>
      <div class="card-body">
        <% visible_genders = @data[:representation][:by_gender].reject { |g| g[:anonymized] } %>
        <% if visible_genders.any? %>
          <div data-controller="chart"
               data-chart-type-value="pie"
               data-chart-data-value="<%= {
                 labels: visible_genders.map { |g| g[:label] },
                 datasets: [{
                   data: visible_genders.map { |g| g[:count] },
                   backgroundColor: ['#3B82F6', '#EC4899', '#8B5CF6', '#6B7280']
                 }]
               }.to_json %>">
            <canvas data-chart-target="canvas"></canvas>
          </div>
        <% else %>
          <div class="text-center text-muted py-4">Insufficient data for visualization</div>
        <% end %>
      </div>
      <div class="card-footer p-0">
        <table class="table table-sm mb-0">
          <tbody>
            <% @data[:representation][:by_gender].each do |row| %>
              <tr class="<%= row[:anonymized] ? 'text-muted' : '' %>">
                <td><%= row[:label] %></td>
                <td class="text-end"><%= row[:count] %></td>
                <td class="text-end"><%= row[:percentage] ? "#{row[:percentage]}%" : "-" %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Hiring Diversity Comparison -->
<% if @data[:hiring_diversity][:total_hired] && @data[:hiring_diversity][:total_hired] > 0 %>
  <div class="card mt-4">
    <div class="card-header">
      <h5 class="card-title mb-0">Hiring vs Applicant Pool Comparison</h5>
    </div>
    <div class="card-body">
      <% if @data[:hiring_diversity][:comparison_to_applicants].any? %>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Group</th>
                <th class="text-end">Applicant Pool</th>
                <th class="text-end">Hired</th>
                <th class="text-end">Difference</th>
                <th>Trend</th>
              </tr>
            </thead>
            <tbody>
              <% @data[:hiring_diversity][:comparison_to_applicants].each do |row| %>
                <tr>
                  <td><%= row[:label] %></td>
                  <td class="text-end"><%= row[:applicant_percentage] %>%</td>
                  <td class="text-end"><%= row[:hire_percentage] %>%</td>
                  <td class="text-end">
                    <span class="<%= row[:difference] > 0 ? 'text-success' : row[:difference] < 0 ? 'text-danger' : 'text-muted' %>">
                      <%= row[:difference] > 0 ? '+' : '' %><%= row[:difference] %>%
                    </span>
                  </td>
                  <td>
                    <% if row[:difference] > 2 %>
                      <i class="bi bi-arrow-up-circle-fill text-success"></i>
                    <% elsif row[:difference] < -2 %>
                      <i class="bi bi-arrow-down-circle-fill text-danger"></i>
                    <% else %>
                      <i class="bi bi-dash-circle text-muted"></i>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="text-center text-muted py-4">Insufficient data for comparison</div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Diversity Trend -->
<div class="card mt-4">
  <div class="card-header">
    <h5 class="card-title mb-0">Diversity Index Trend</h5>
  </div>
  <div class="card-body">
    <% if @data[:trends].any? %>
      <div data-controller="chart"
           data-chart-type-value="line"
           data-chart-data-value="<%= {
             labels: @data[:trends].map { |t| t[:label] },
             datasets: [{
               label: 'Diversity Index',
               data: @data[:trends].map { |t| t[:diversity_index] },
               borderColor: '#8B5CF6',
               backgroundColor: 'rgba(139, 92, 246, 0.1)',
               fill: true
             }]
           }.to_json %>"
           data-chart-options-value="<%= {
             scales: { y: { min: 0, max: 1 } }
           }.to_json %>">
        <canvas data-chart-target="canvas" height="100"></canvas>
      </div>
    <% else %>
      <div class="text-center text-muted py-4">Insufficient trend data</div>
    <% end %>
  </div>
</div>
