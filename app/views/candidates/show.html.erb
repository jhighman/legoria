<!-- Header -->
<div class="d-flex justify-content-between align-items-start mb-4">
  <div class="d-flex align-items-center">
    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
      <span class="fs-5 fw-medium"><%= @candidate.initials %></span>
    </div>
    <div class="ms-3">
      <h1 class="h3 mb-1"><%= @candidate.full_name %></h1>
      <div class="d-flex align-items-center gap-3 text-muted">
        <% if @candidate.location.present? %>
          <span><i class="bi bi-geo-alt me-1"></i><%= @candidate.location %></span>
        <% end %>
        <span class="small">Added <%= time_ago_in_words(@candidate.created_at) %> ago</span>
      </div>
    </div>
  </div>
  <div class="d-flex gap-2">
    <%= link_to edit_candidate_path(@candidate), class: "btn btn-outline-secondary" do %>
      <i class="bi bi-pencil me-1"></i> Edit
    <% end %>
    <% if policy(@candidate).destroy? %>
      <%= button_to candidate_path(@candidate), method: :delete, class: "btn btn-outline-danger", data: { turbo_confirm: "Are you sure you want to archive this candidate?" } do %>
        <i class="bi bi-archive me-1"></i> Archive
      <% end %>
    <% end %>
  </div>
</div>

<div class="row g-4">
  <!-- Main content (2/3) -->
  <div class="col-lg-8">
    <!-- Contact Information -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Contact Information</h5>
        <div class="row g-3 mt-2">
          <div class="col-md-6">
            <dt class="text-muted small">Email</dt>
            <dd><a href="mailto:<%= @candidate.email %>" class="text-decoration-none"><%= @candidate.email %></a></dd>
          </div>
          <div class="col-md-6">
            <dt class="text-muted small">Phone</dt>
            <dd><%= @candidate.phone.present? ? @candidate.masked_phone : "â€”" %></dd>
          </div>
          <% if @candidate.linkedin_url.present? %>
            <div class="col-md-6">
              <dt class="text-muted small">LinkedIn</dt>
              <dd><a href="<%= @candidate.linkedin_url %>" target="_blank" class="text-decoration-none">View Profile <i class="bi bi-box-arrow-up-right"></i></a></dd>
            </div>
          <% end %>
          <% if @candidate.portfolio_url.present? %>
            <div class="col-md-6">
              <dt class="text-muted small">Portfolio</dt>
              <dd><a href="<%= @candidate.portfolio_url %>" target="_blank" class="text-decoration-none">View Portfolio <i class="bi bi-box-arrow-up-right"></i></a></dd>
            </div>
          <% end %>
        </div>
        <% if @candidate.summary.present? %>
          <div class="mt-3 pt-3 border-top">
            <dt class="text-muted small">Summary</dt>
            <dd class="mb-0"><%= @candidate.summary %></dd>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Applications -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Applications (<%= @applications.count %>)</h5>

        <% if @applications.any? %>
          <div class="mt-3">
            <% @applications.each do |application| %>
              <div class="border rounded p-3 mb-3">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <%= link_to application.job.title, job_path(application.job), class: "fw-medium text-decoration-none" %>
                    <p class="text-muted small mb-0 mt-1">
                      Applied <%= time_ago_in_words(application.applied_at) %> ago
                      <% if application.days_in_current_stage > 0 %>
                        &bull; <%= application.days_in_current_stage %> days in <%= application.current_stage_name %>
                      <% end %>
                    </p>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <%= render partial: "applications/status_badge", locals: { application: application } %>
                    <% if application.starred? %>
                      <i class="bi bi-star-fill text-warning"></i>
                    <% end %>
                    <% if application.rating.present? %>
                      <span class="small text-muted"><%= application.rating %>/5</span>
                    <% end %>
                  </div>
                </div>
                <div class="mt-2 d-flex align-items-center gap-2 small">
                  <span class="badge bg-light text-dark"><%= application.current_stage_name %></span>
                  <span class="text-muted">&bull;</span>
                  <span class="text-muted">Source: <%= application.source_label %></span>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-muted text-center py-4 mb-0">No applications yet</p>
        <% end %>
      </div>
    </div>

    <!-- Resumes -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Resumes (<%= @resumes.count %>)</h5>
          <% if policy(@candidate).upload_resume? %>
            <button type="button" class="btn btn-link btn-sm" data-controller="modal" data-action="click->modal#open">
              <i class="bi bi-upload me-1"></i> Upload Resume
            </button>
          <% end %>
        </div>

        <% if @resumes.any? %>
          <div class="mt-3">
            <% @resumes.each do |resume| %>
              <div class="d-flex align-items-center justify-content-between p-3 border rounded mb-2">
                <div class="d-flex align-items-center">
                  <div class="rounded bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="bi bi-file-earmark-text text-muted"></i>
                  </div>
                  <div class="ms-3">
                    <p class="mb-0 fw-medium">
                      <%= resume.filename %>
                      <% if resume.primary? %>
                        <span class="badge bg-success ms-2">Primary</span>
                      <% end %>
                    </p>
                    <p class="mb-0 text-muted small">
                      <%= resume.file_type_label %> &bull; <%= resume.file_size_formatted %> &bull; Uploaded <%= time_ago_in_words(resume.created_at) %> ago
                    </p>
                  </div>
                </div>
                <% if resume.file.attached? %>
                  <%= link_to rails_blob_path(resume.file, disposition: "attachment"), class: "btn btn-sm btn-outline-primary" do %>
                    <i class="bi bi-download"></i>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-muted text-center py-4 mb-0">No resumes uploaded</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Sidebar (1/3) -->
  <div class="col-lg-4">
    <!-- Notes -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Notes (<%= @notes.count %>)</h5>

        <!-- Add note form -->
        <% if policy(@candidate).add_note? %>
          <div id="note_form" class="mt-3 mb-4">
            <%= render partial: "candidates/note_form", locals: { candidate: @candidate, note: CandidateNote.new } %>
          </div>
        <% end %>

        <% if @notes.any? %>
          <div id="notes_list">
            <% @notes.each do |note| %>
              <div class="border-start <%= note.pinned? ? 'border-warning' : 'border-secondary' %> border-2 ps-3 mb-3">
                <div class="d-flex justify-content-between small">
                  <span class="fw-medium"><%= note.author_name %></span>
                  <span class="text-muted"><%= time_ago_in_words(note.created_at) %> ago</span>
                </div>
                <p class="small text-muted mb-1"><%= note.content %></p>
                <div class="small text-muted">
                  <% case note.visibility %>
                  <% when "private" %>
                    <i class="bi bi-lock me-1"></i> Private
                  <% when "team" %>
                    <i class="bi bi-people me-1"></i> Team
                  <% when "hiring_team" %>
                    <i class="bi bi-briefcase me-1"></i> Hiring Team
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-muted text-center py-3 small mb-0">No notes yet</p>
        <% end %>
      </div>
    </div>

    <!-- Timeline -->
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Activity Timeline</h5>
        <%= render partial: "candidates/timeline", locals: { timeline: @timeline } %>
      </div>
    </div>
  </div>
</div>
