<div id="flash-messages"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1"><%= @job.title %> Pipeline</h1>
    <p class="text-muted mb-0">
      <%= @applications.count %> candidate<%= @applications.count == 1 ? "" : "s" %>
      <% if @job.open? %>
        <span class="badge bg-success ms-2">Open</span>
      <% else %>
        <span class="badge bg-secondary ms-2"><%= @job.status.humanize %></span>
      <% end %>
    </p>
  </div>
  <div class="d-flex gap-2">
    <div class="btn-group" role="group">
      <%= link_to job_pipeline_path(@job), class: "btn btn-outline-primary" do %>
        <i class="bi bi-kanban me-1"></i> Kanban
      <% end %>
      <%= link_to list_job_pipeline_path(@job), class: "btn btn-primary" do %>
        <i class="bi bi-list-ul me-1"></i> List
      <% end %>
    </div>
    <%= link_to new_job_application_path(@job), class: "btn btn-success" do %>
      <i class="bi bi-plus me-1"></i> Add Candidate
    <% end %>
  </div>
</div>

<!-- Filters -->
<%= render "pipeline/filters" %>

<!-- Applications Table -->
<div class="card">
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th style="width: 40px;"></th>
          <th>Candidate</th>
          <th>Stage</th>
          <th>Source</th>
          <th>Rating</th>
          <th>Applied</th>
          <th>Days in Stage</th>
          <th style="width: 120px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @applications.each do |application| %>
          <tr id="<%= dom_id(application) %>">
            <td class="align-middle">
              <% if application.starred? %>
                <%= button_to unstar_application_job_pipeline_path(@job, id: application.id),
                    method: :post, class: "btn btn-link btn-sm p-0 text-warning" do %>
                  <i class="bi bi-star-fill"></i>
                <% end %>
              <% else %>
                <%= button_to star_application_job_pipeline_path(@job, id: application.id),
                    method: :post, class: "btn btn-link btn-sm p-0 text-muted" do %>
                  <i class="bi bi-star"></i>
                <% end %>
              <% end %>
            </td>
            <td class="align-middle">
              <div class="d-flex align-items-center">
                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2" style="width: 36px; height: 36px;">
                  <small><%= application.candidate.initials %></small>
                </div>
                <div>
                  <div class="fw-medium">
                    <%= link_to application.candidate.full_name, candidate_path(application.candidate), class: "text-decoration-none" %>
                  </div>
                  <div class="text-muted small"><%= application.candidate.email %></div>
                </div>
              </div>
            </td>
            <td class="align-middle">
              <% if application.current_stage.color.present? %>
                <span class="rounded-circle me-1" style="width: 8px; height: 8px; background-color: <%= application.current_stage.color %>; display: inline-block;"></span>
              <% end %>
              <%= application.current_stage.name %>
            </td>
            <td class="align-middle">
              <span class="badge bg-light text-dark border"><%= application.source_label %></span>
            </td>
            <td class="align-middle">
              <% if application.rating.present? %>
                <% application.rating.times do %>
                  <i class="bi bi-star-fill text-warning" style="font-size: 0.8rem;"></i>
                <% end %>
              <% else %>
                <span class="text-muted">-</span>
              <% end %>
            </td>
            <td class="align-middle">
              <span title="<%= application.applied_at.strftime('%B %d, %Y') %>">
                <%= time_ago_in_words(application.applied_at) %> ago
              </span>
            </td>
            <td class="align-middle">
              <% days = application.days_in_current_stage %>
              <% if days > 14 %>
                <span class="badge bg-danger"><%= days %> days</span>
              <% elsif days > 7 %>
                <span class="badge bg-warning text-dark"><%= days %> days</span>
              <% else %>
                <span class="text-muted"><%= days %> days</span>
              <% end %>
            </td>
            <td class="align-middle">
              <div class="btn-group btn-group-sm">
                <div class="dropdown">
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Move
                  </button>
                  <ul class="dropdown-menu">
                    <% @job.stages.ordered.each do |stage| %>
                      <% unless stage.id == application.current_stage_id %>
                        <li>
                          <%= button_to move_stage_job_pipeline_path(@job, id: application.id, stage_id: stage.id),
                              method: :post, class: "dropdown-item" do %>
                            <% if stage.color.present? %>
                              <span class="rounded-circle me-2" style="width: 8px; height: 8px; background-color: <%= stage.color %>; display: inline-block;"></span>
                            <% end %>
                            <%= stage.name %>
                          <% end %>
                        </li>
                      <% end %>
                    <% end %>
                  </ul>
                </div>
                <% if application.active? %>
                  <button type="button" class="btn btn-outline-danger"
                          data-bs-toggle="modal"
                          data-bs-target="#rejectModal"
                          data-application-id="<%= application.id %>"
                          data-candidate-name="<%= application.candidate.full_name %>">
                    <i class="bi bi-x"></i>
                  </button>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
        <% if @applications.empty? %>
          <tr>
            <td colspan="8" class="text-center py-5">
              <i class="bi bi-inbox fs-1 text-muted d-block mb-3"></i>
              <p class="text-muted mb-0">No candidates in this pipeline</p>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!-- Rejection Modal -->
<%= render "pipeline/rejection_modal" %>
