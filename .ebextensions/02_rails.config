# Rails configuration for Elastic Beanstalk
#
# IMPORTANT: This is a template file for PUBLIC repository.
# Sensitive values use SSM Parameter Store references.
# See: trua-iac repository (private) for actual infrastructure values.
#
# MVP Infrastructure Model:
# - Single production environment (no staging)
# - Shared VPC and RDS instance with trua_collect
# - Dedicated schema in shared database

option_settings:
  aws:autoscaling:launchconfiguration:
    EC2KeyName: '{{resolve:ssm:/trua/ec2-keypair}}'

  aws:elasticbeanstalk:application:environment:
    # Rails environment
    RAILS_ENV: production
    RACK_ENV: production
    RAILS_SKIP_ASSET_COMPILATION: false
    RAILS_SERVE_STATIC_FILES: true
    RAILS_LOG_TO_STDOUT: true

    # Database configuration (shared RDS, dedicated schema)
    # IAM auth - no password needed, tokens generated at runtime
    DB_HOST: '{{resolve:ssm:/trua/rds-endpoint}}'
    DB_PORT: '5432'
    DB_NAME: '{{resolve:ssm:/trua/rds-dbname}}'
    DB_USER: trua_apply_app
    DB_SCHEMA: trua_apply

    # AWS Region
    AWS_REGION: us-east-1

    # S3 Buckets (shared infrastructure, app-specific prefixes)
    S3_UPLOADS_BUCKET: '{{resolve:ssm:/trua/s3-uploads-bucket}}'
    S3_ASSETS_BUCKET: '{{resolve:ssm:/trua/s3-assets-bucket}}'

container_commands:
  01_db_migrate:
    command: "RAILS_ENV=production bundle exec rails db:migrate"
    leader_only: true
  02_db_seed:
    command: "RAILS_ENV=production bundle exec rails db:seed"
    leader_only: true
